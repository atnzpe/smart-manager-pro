<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #F3F4F6;
    }

    /* Estilos das Abas */
    .nav-tab {
      cursor: pointer;
      padding: 12px;
      text-align: center;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      flex: 1;
      transition: all 0.2s;
      font-size: 0.8rem;
    }

    .nav-tab.active {
      border-bottom-color: #8B5CF6;
      color: #8B5CF6;
      background: #fff;
    }

    .nav-tab:hover:not(.active) {
      background: #e5e7eb;
    }

    /* Estilos Gerais */
    .card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .input-field {
      width: 100%;
      padding: 8px;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 0.875rem;
      margin-bottom: 8px;
      outline: none;
    }

    .input-field:focus {
      border-color: #8B5CF6;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }

    .btn-primary {
      background-color: #8B5CF6;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
    }

    .btn-primary:hover {
      background-color: #7C3AED;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #8B5CF6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="p-0">

  <div class="flex bg-gray-100 border-b border-gray-200 sticky top-0 z-50">
    <div class="nav-tab active" onclick="switchTab('dash')" id="tab-dash"><i
        class="fas fa-chart-pie block mb-1"></i>Dash</div>
    <div class="nav-tab" onclick="switchTab('crud')" id="tab-crud"><i class="fas fa-list block mb-1"></i>Gest√£o</div>
    <div class="nav-tab" onclick="switchTab('config')" id="tab-config"><i class="fas fa-cog block mb-1"></i>Config</div>
  </div>

  <div id="view-dash" class="p-4 space-y-4 animate-fade-in">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-lg font-bold text-gray-800" id="dash-app-name">...</h1>
        <p class="text-xs text-gray-500">Financeiro Atual</p>
      </div>
      <button onclick="loadDashboardData()" class="text-gray-400 hover:text-blue-500"><i
          class="fas fa-sync"></i></button>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div class="card border-l-4 border-blue-500">
        <p class="text-xs text-gray-500 font-bold uppercase">Hoje</p>
        <h2 class="text-xl font-bold text-gray-800" id="val-today">...</h2>
      </div>
      <div class="card border-l-4 border-green-500">
        <p class="text-xs text-gray-500 font-bold uppercase">M√™s</p>
        <h2 class="text-xl font-bold text-gray-800" id="val-month">...</h2>
      </div>
    </div>

    <div class="card">
      <h3 class="text-sm font-bold text-gray-700 mb-3 border-b pb-2">Receita: Vendas vs Servi√ßos</h3>
      <div class="relative h-48"><canvas id="myChart"></canvas></div>
    </div>
  </div>

  <div id="view-crud" class="hidden p-3 pb-20">
    <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
      <select id="module-selector" onchange="loadTable()"
        class="w-full p-2 border rounded-md font-semibold text-gray-700 bg-gray-50 focus:ring-2 focus:ring-violet-200 outline-none">
        <option value="SERVICOS">üíÜ‚Äç‚ôÄÔ∏è Servi√ßos</option>
        <option value="PRODUTOS">üõçÔ∏è Produtos</option>
        <option value="PEDIDOS">üì¶ Pedidos (KDS)</option>
        <option value="AGENDAMENTOS">üìÖ Agendamentos</option>
        <option value="INSUMOS">üß™ Insumos</option>
        <option value="CLIENTES">üë• Clientes</option>
        <option value="USUARIOS">üîê Usu√°rios</option>
        <option value="TAXAS_ENTREGA">üõµ Taxas Entrega</option>
        <option value="FORMAS_PAGAMENTO">üí≥ Pagamentos</option>
      </select>
    </div>

    <div class="flex justify-between items-center px-1 mb-2">
      <h3 class="font-bold text-gray-700 text-sm">Lista de Registros</h3>
      <button onclick="openForm()"
        class="bg-green-500 text-white w-8 h-8 rounded-full shadow hover:bg-green-600 flex items-center justify-center"><i
          class="fas fa-plus"></i></button>
    </div>

    <div id="loading-crud" class="text-center py-4 text-gray-400 hidden"><i class="fas fa-spinner fa-spin"></i></div>
    <div id="items-container" class="space-y-2"></div>
  </div>

  <div id="view-config" class="hidden p-4 space-y-4">
    <div class="card">
      <h3 class="text-sm font-bold text-gray-700 mb-3">Personaliza√ß√£o</h3>
      <label class="block text-xs font-bold text-gray-500 mb-1">NOME DA EMPRESA (APP)</label>
      <input type="text" id="cfg-app-name" class="input-field" placeholder="Ex: Barbearia Top">
      <button onclick="saveConfigName()" id="btn-save-cfg" class="btn-primary mt-2">Salvar Altera√ß√£o</button>
      <p class="text-xs text-gray-400 mt-2">Isso altera o t√≠tulo no topo do App do cliente.</p>
    </div>

    <div class="card bg-yellow-50 border border-yellow-100">
      <h3 class="text-sm font-bold text-yellow-700 mb-2">üí° Dica Pro</h3>
      <p class="text-xs text-yellow-600">Para alterar o WhatsApp ou ID do Calendar, use a aba "Gest√£o" e selecione o
        m√≥dulo CONFIG na lista.</p>
    </div>
  </div>

  <div id="view-form" class="hidden fixed inset-0 bg-white z-50 flex flex-col h-screen animate-fade-in">
    <div class="p-3 border-b flex justify-between items-center bg-gray-50">
      <h3 class="font-bold text-gray-800" id="form-title">Editar</h3>
      <button onclick="closeForm()" class="text-gray-500 hover:text-red-500"><i
          class="fas fa-times text-lg"></i></button>
    </div>
    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="form-fields"></div>
    <div id="area-ficha-tecnica" class="hidden p-3 border-t bg-gray-50">
      <h4 class="font-bold text-xs text-gray-500 mb-2 uppercase">Ficha T√©cnica (Receita)</h4>
      <div id="ft-lista" class="space-y-2 mb-3"></div>

      <div class="flex gap-1 items-center">
        <select id="ft-select-insumo" class="flex-1 w-0 p-2 text-xs border rounded bg-white h-9"></select>
        <input type="number" id="ft-qtd" placeholder="Qtd" class="w-12 p-2 text-xs border rounded h-9 text-center">
        <button onclick="addInsumoToFicha()"
          class="bg-blue-500 text-white w-9 h-9 rounded flex items-center justify-center hover:bg-blue-600 flex-shrink-0">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
    <div class="p-3 border-t bg-gray-50">
      <button onclick="saveItem()" class="btn-primary" id="btn-save">Salvar</button>
      <button onclick="deleteCurrentItem()" id="btn-delete"
        class="text-red-500 text-sm w-full mt-2 underline hidden">Excluir</button>
    </div>
  </div>

  <script>
    // --- NAVEGA√á√ÉO ---
    function switchTab(tab) {
      document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      ['dash', 'crud', 'config'].forEach(v => document.getElementById('view-' + v).classList.add('hidden'));
      document.getElementById('view-' + tab).classList.remove('hidden');

      if (tab === 'dash') loadDashboardData();
      if (tab === 'crud' && document.getElementById('items-container').innerHTML === '') loadTable();
    }

    // --- DASHBOARD ---
    let myChart = null;
    function loadDashboardData() {
      document.getElementById('val-today').innerHTML = '<div class="loader"></div>';
      google.script.run.withSuccessHandler(renderDashboard).getDashboardMetrics();
    }
    function renderDashboard(data) {
      document.getElementById('dash-app-name').innerText = data.appName;
      document.getElementById('cfg-app-name').value = data.appName; // Preenche config tamb√©m
      document.getElementById('val-today').innerText = 'R$ ' + data.totalToday.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      document.getElementById('val-month').innerText = 'R$ ' + data.totalMonth.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

      const ctx = document.getElementById('myChart').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Vendas', 'Servi√ßos'],
          datasets: [{ data: [data.byType['Vendas'], data.byType['Servi√ßos']], backgroundColor: ['#3B82F6', '#8B5CF6'], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }

    // --- CONFIGURA√á√ÉO ---
    function saveConfigName() {
      const name = document.getElementById('cfg-app-name').value;
      const btn = document.getElementById('btn-save-cfg');
      btn.innerText = 'Salvando...'; btn.disabled = true;
      google.script.run.withSuccessHandler(() => {
        btn.innerText = 'Salvo com Sucesso!';
        setTimeout(() => { btn.innerText = 'Salvar Altera√ß√£o'; btn.disabled = false; }, 2000);
      }).setAppName(name);
    }

    // --- CRUD SYSTEM (C√ìDIGO ORIGINAL) ---
    let currentSchema = [], currentSheet = "", editingId = null, availableInsumos = [], fichaTecnicaTemp = [];

    function loadTable() {
      currentSheet = document.getElementById('module-selector').value;
      document.getElementById('items-container').innerHTML = '';
      document.getElementById('loading-crud').classList.remove('hidden');
      google.script.run.withSuccessHandler(renderList).withFailureHandler(alert).crudGetTableData(currentSheet);
    }

    function renderList(data) {
      document.getElementById('loading-crud').classList.add('hidden');
      currentSchema = data.headers;
      if (data.extraData) availableInsumos = data.extraData;
      const c = document.getElementById('items-container');
      if (!data.items.length) { c.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4">Vazio.</p>'; return; }

      data.items.forEach(item => {
        let title = item.Nome || item.Email || item.ID;
        let sub = item.Preco ? `R$ ${item.Preco}` : (item.Telefone || item.Categoria || '');
        if (currentSheet === 'PEDIDOS') { try { let cl = JSON.parse(item.Cliente_Json); title = `#${item.ID.split('-')[1]} - ${cl.nome}`; sub = item.Status; } catch (e) { } }

        const div = document.createElement('div');
        div.className = "bg-white p-3 rounded border shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50";
        div.onclick = () => openForm(item);
        div.innerHTML = `<div><div class="font-bold text-gray-800 text-sm truncate w-48">${title}</div><div class="text-xs text-gray-500">${sub}</div></div><i class="fas fa-chevron-right text-gray-300 text-xs"></i>`;
        c.appendChild(div);
      });
    }

    function openForm(item = null) {
      const c = document.getElementById('form-fields'); c.innerHTML = '';
      editingId = item ? item.ID : null;
      fichaTecnicaTemp = [];
      document.getElementById('form-title').innerText = item ? 'Editar' : 'Novo';
      document.getElementById('btn-delete').classList.toggle('hidden', !item);

      const isServ = currentSheet === 'SERVICOS';
      document.getElementById('area-ficha-tecnica').classList.toggle('hidden', !isServ);
      if (isServ) setupFichaTecnica(item);

      currentSchema.forEach(h => {
        if (h === 'ID' || h === 'Ficha_Tecnica_Json') return;
        const div = document.createElement('div');
        div.innerHTML = `<label class="block text-xs font-bold text-gray-600 mb-1 uppercase">${h.replace(/_/g, ' ')}</label>`;
        let input; const val = item ? item[h] : '';
        if (h === 'Ativo') input = createSel(['true', 'false'], ['Sim', 'N√£o'], val || 'true');
        else if (h === 'Nivel' && currentSheet === 'USUARIOS') input = createSel(['ADMIN', 'COLABORADOR', 'ENTREGADOR'], ['Admin', 'Colaborador', 'Entregador'], val || 'COLABORADOR');
        else {
          input = document.createElement(h.includes('Obs') || h.includes('Descricao') ? 'textarea' : 'input');
          input.className = "input-field";
          if (input.tagName === 'INPUT') {
            input.type = (h.includes('Preco') || h.includes('Custo') || h.includes('Estoque') || h.includes('Minutos')) ? 'number' : 'text';
            if (input.type === 'number') input.step = "0.01";
          }
          input.value = val;
        }
        input.id = `inp-${h}`;
        div.appendChild(input);
        c.appendChild(div);
      });
      document.getElementById('view-form').classList.remove('hidden');
    }

    function createSel(v, l, s) {
      const sel = document.createElement('select'); sel.className = "input-field bg-white";
      v.forEach((val, i) => { const opt = document.createElement('option'); opt.value = val; opt.innerText = l[i]; if (String(val) === String(s)) opt.selected = true; sel.appendChild(opt); });
      return sel;
    }

    function saveItem() {
      const btn = document.getElementById('btn-save'); btn.innerText = 'Salvando...'; btn.disabled = true;
      let p = { ID: editingId };
      currentSchema.forEach(h => { if (h !== 'ID' && h !== 'Ficha_Tecnica_Json') { const el = document.getElementById(`inp-${h}`); if (el) p[h] = el.value; } });
      if (currentSheet === 'SERVICOS') p.Ficha_Tecnica_Json = JSON.stringify(fichaTecnicaTemp);
      google.script.run.withSuccessHandler(() => { btn.innerText = 'Salvar'; btn.disabled = false; closeForm(); loadTable(); }).crudSaveItem(currentSheet, p);
    }

    function deleteCurrentItem() { if (confirm("Deletar?")) google.script.run.withSuccessHandler(() => { closeForm(); loadTable(); }).crudDeleteItem(currentSheet, editingId); }
    function closeForm() { document.getElementById('view-form').classList.add('hidden'); }

    // --- FICHA T√âCNICA ---
    function setupFichaTecnica(item) {
      const sel = document.getElementById('ft-select-insumo'); sel.innerHTML = '<option value="">Item...</option>';
      availableInsumos.forEach(i => sel.innerHTML += `<option value="${i.ID}">${i.Nome} (${i.Unidade})</option>`);
      try { fichaTecnicaTemp = item && item.Ficha_Tecnica_Json ? JSON.parse(item.Ficha_Tecnica_Json) : []; } catch (e) { fichaTecnicaTemp = []; }
      renderFicha();
    }
    function addInsumoToFicha() {
      const sel = document.getElementById('ft-select-insumo'), qtd = document.getElementById('ft-qtd');
      if (!sel.value || !qtd.value) return;
      const exists = fichaTecnicaTemp.find(x => x.id_insumo === sel.value);
      if (exists) exists.qtd = qtd.value; else fichaTecnicaTemp.push({ id_insumo: sel.value, qtd: qtd.value, nome_ref: sel.options[sel.selectedIndex].text });
      qtd.value = ''; renderFicha();
    }
    function removeInsumo(id) { fichaTecnicaTemp = fichaTecnicaTemp.filter(i => i.id_insumo !== id); renderFicha(); }
    function renderFicha() {
      const d = document.getElementById('ft-lista'); d.innerHTML = '';
      fichaTecnicaTemp.forEach(i => {
        let nome = i.nome_ref; if (!nome && availableInsumos.length) { const f = availableInsumos.find(x => x.ID == i.id_insumo); if (f) nome = `${f.Nome} (${f.Unidade})`; }
        d.innerHTML += `<div class="flex justify-between bg-white p-2 border rounded text-xs"><span>${nome || i.id_insumo}</span><div class="flex gap-2"><span class="font-bold">${i.qtd}</span><button onclick="removeInsumo('${i.id_insumo}')" class="text-red-500">üóëÔ∏è</button></div></div>`;
      });
    }

    // Init
    window.onload = () => switchTab('dash');
  </script>
</body>

</html>